pipeline {
    agent any

    environment {
        TERRAFORM_PATH = 'C:\\terraform_1.11.3_windows_386\\terraform.exe'
    }

    stages {
        stage('SCM Checkout') {
            steps {
                retry(3) {
                    git branch: 'main', url: 'https://github.com/GiharaNavindu/talks-dev.git'
                }
            }
        }

        stage('Provision Infrastructure') {
            steps {
                dir('terraform') {
                    script {
                        echo "Checking if Terraform exists at ${TERRAFORM_PATH}"
                        def terraformExists = bat(script: "if exist ${TERRAFORM_PATH} echo Found", returnStdout: true).trim()
                        if (terraformExists != "Found") {
                            error "Terraform not found at ${TERRAFORM_PATH}. Check your path!"
                        }

                        echo "Initializing Terraform..."
                        bat "${TERRAFORM_PATH} init"

                        echo "Applying Terraform configuration..."
                        bat "${TERRAFORM_PATH} apply -auto-approve"

                        echo "Fetching EC2 Public IP..."
                        def ec2PublicIp = bat(script: "${TERRAFORM_PATH} output -raw instance_ip", returnStdout: true).trim()
                        env.EC2_PUBLIC_IP = ec2PublicIp
                        echo "Provisioned EC2 Instance IP: ${env.EC2_PUBLIC_IP}"
                    }
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline execution completed!"
        }
    }
}
